#pragma once
#include <Windows.h>
#include <string>
#include <iostream>
#include <vector>
#include <fstream>
#include <istream>
#include <iterator>
#include <sstream>

#include "RLUA.h"





void ConsoleBypass(const char* Title) {
	DWORD aaaa;
	VirtualProtect((PVOID)&FreeConsole, 1, PAGE_EXECUTE_READWRITE, &aaaa);
	*(BYTE*)(&FreeConsole) = 0xC3;
	AllocConsole();
	SetConsoleTitleA(Title);
	freopen("CONOUT$", "w", stdout);
	freopen("CONIN$", "r", stdin);
	HWND ConsoleHandle = GetConsoleWindow();
	::SetWindowPos(ConsoleHandle, HWND_TOPMOST, 0, 0, 0, 0, SWP_DRAWFRAME | SWP_NOMOVE | SWP_NOSIZE | SWP_SHOWWINDOW);
	::ShowWindow(ConsoleHandle, SW_NORMAL);
}

static std::vector<std::string> SplitArguments(std::string string)
{
	std::vector<std::string> elements;
	std::stringstream start(string);
	std::istream_iterator<std::string> begin(start);
	std::istream_iterator<std::string> end;
	std::vector<std::string> vectorStrings(begin, end);
	return vectorStrings;
}




void luac(std::string input) {
	try {
		std::vector<std::string> args = SplitArguments(input);

		if (args.at(0) == "getfield") {
			r_lgfield(RESTATE, stoi(args.at(1)), args.at(2).c_str());
			
		}

		else if (args.at(0) == "getglobal") {
			r_l_getglobal(RESTATE, args.at(1).c_str());
			
		}

		else if (args.at(0) == "pushstring") {
			r_lpstring(RESTATE, args.at(1).c_str());
			
		}

		else if (args.at(0) == "pcall") {
			r_lpcall(RESTATE, stoi(args.at(1)), stoi(args.at(2)), stoi(args.at(3)));
			
		}
	}
	catch (...) {
		std::cout << "was not able to execute what was inputted" << std::endl;

	}
}

int main() {

	ConsoleBypass("Nigger");

	auto SCVFTBLE = x(0xdeadb33f); // yall can find this.


	std::cout << "Yeet Started scanning...... " << "\n";
	ScriptContext = Memory::Scan((BYTE*)&SCVFTBLE, (BYTE*)"xxxx", PAGE_READWRITE);
	if (!ScriptContext) {
		printf("ScriptContext Scan Failed!\n");
		system("pause");
		exit(0);
	}

	int v39 = ScriptContext;
	int v51 = 0;
	RESTATE = (ScriptContext + 56 * 0 + 172) ^ *(DWORD *)(ScriptContext + 56 * 0 + 172);
	printf("Finished the scanning....\n");

	std::cout << "RSTATE:  " << std::uppercase << std::hex << ScriptContext << std::endl;
	std::cout << "LUA STATE:  " << std::uppercase << std::hex << RESTATE << std::endl;

	while (true)
	{
		
		std::string Yeet;
		std::getline(std::cin, Yeet);		
		luac(Yeet);
		
	}




	return 1;
}


BOOL APIENTRY DllMain(HMODULE Module, DWORD Reason, void* Reserved)
{
	switch (Reason)
	{
	case DLL_PROCESS_ATTACH:
		DisableThreadLibraryCalls(Module);
		CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)main, NULL, NULL, NULL);
		break;
	case DLL_PROCESS_DETACH:
		//MH_Uninitialize();
		exit(0);
		break;
	default: break;
	}
	return TRUE;
}

